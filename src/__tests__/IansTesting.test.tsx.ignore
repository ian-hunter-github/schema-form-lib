import { render, screen, fireEvent } from "@testing-library/react";
import { it, expect } from "vitest";
import { FormStateProvider } from "../contexts/FormStateContext";
import {
  toBeInTheDocument,
  toHaveValue,
  toBeChecked,
  toBeDisabled,
  toHaveTextContent,
  toHaveAttribute,
} from "@testing-library/jest-dom/matchers";
import type { JSONSchemaProperties } from "../types/schema";

expect.extend({
  toBeInTheDocument,
  toHaveValue,
  toBeChecked,
  toBeDisabled,
  toHaveTextContent,
  toHaveAttribute,
});

it("simple validation of fields", async () => {
  const schema = {
    type: "object" as const,
    properties: {
      outerField: {
        type: "string",
        minLength: 3,
      },
      object: {
        type: "object",
        properties: {
          innerField: {
            type: "string",
            minLength: 5,
          },
          innerObject: {
            type: "object",
            properties: {
              innerField: {
                type: "string",
                minLength: 5,
              },
            },
          },
        },
      },
    } as JSONSchemaProperties,
  };

  render(<div>Test placeholder - FormRenderer should be used instead</div>);

  // Verify the accordion exists and can be clicked
  const accordion = screen.getByTestId("object-accordion");
  expect(accordion).toBeInTheDocument();
  fireEvent.click(accordion);

  const accordion2 = screen.getByTestId("object.innerObject-accordion");
  expect(accordion2).toBeInTheDocument();
  fireEvent.click(accordion2);

  const element = document.querySelector("#outerField-error");
  expect(element).toBeNull(); // Passes if element does not exist

  // Test outervalidation
  const outerField = screen.getByTestId("outerField");
  fireEvent.change(outerField, {
    target: { value: "Al" },
  });
  fireEvent.blur(outerField);

  expect(screen.getByTestId("outerField-error")).toBeInTheDocument();

  // Test inner validation
  const innerField = screen.getByTestId("object.innerObject.innerField");
  fireEvent.change(innerField, {
    target: { value: "Al" },
  });
  fireEvent.blur(innerField);

  expect(
    screen.getByTestId("object.innerObject.innerField-error")
  ).toBeInTheDocument();

  //console.log("After validation:", screen.debug());

  // // Submit form
  // fireEvent.submit(screen.getByTestId("form"));

  // // Debug after validation
  // console.log("After validation:", screen.debug());

  // // Verify outerField error is displayed
  // const outerError = await screen.findByTestId("error-outerField.outerField");
  // expect(outerError).toBeInTheDocument();

  // // Verify innerField error is displayed
  // const innerError = await screen.findByTestId(
  //   "error-object.object.innerField.innerField"
  // );
  // expect(innerError).toBeInTheDocument();
});

it("validates min, max constraints", async () => {
  const baseSchema = {
    type: "object",
    required: ["age"],
    properties: {
      name: {
        type: "string",
        minLength: 3,
        maxLength: 7,
        default: "John Doe",
      },
      age: {
        type: "number",
        minimum: 18,
        maximum: 99,
        default: 30,
      },
    } as JSONSchemaProperties,
  };

  render(
    <FormStateProvider>
      <div>Test placeholder - FormRenderer should be used instead</div>
    </FormStateProvider>
  );

  // minLength
  const nameInput = screen.getByTestId("name");
  fireEvent.change(nameInput, { target: { value: "Al" } });
  fireEvent.blur(nameInput);
  expect(await screen.findByTestId("name-error")).toBeInTheDocument();

  // maxLength
  fireEvent.change(nameInput, { target: { value: "VeryLongNameHere" } });
  fireEvent.blur(nameInput);
  expect(await screen.findByTestId("name-error")).toBeInTheDocument();

  // min number
  const ageInput = screen.getByTestId("age");
  fireEvent.change(ageInput, { target: { value: "10" } });
  fireEvent.blur(ageInput);
  expect(await screen.findByTestId("age-error")).toBeInTheDocument();

  // max number
  fireEvent.change(ageInput, { target: { value: "150" } });
  fireEvent.blur(ageInput);
  expect(await screen.findByTestId("age-error")).toBeInTheDocument();
});
